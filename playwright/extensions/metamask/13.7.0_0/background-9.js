LavaPack.loadBundle([[4,{"../../shared/constants/app":5781,"../../shared/constants/background-liveness-check":5782,"../../shared/constants/errors":5786,"../../shared/constants/infura-project-id":5791,"../../shared/constants/messages":5795,"../../shared/constants/metametrics":5796,"../../shared/constants/offscreen-communication":5802,"../../shared/constants/onboarding":5803,"../../shared/constants/referrals":5807,"../../shared/constants/start-up-errors":5812,"../../shared/lib/get-first-preferred-lang-code":5869,"../../shared/lib/manifestFlags":5871,"../../shared/lib/promise-with-resolvers":5880,"../../shared/modules/browser-runtime.utils":5897,"../../shared/modules/caip-stream":5898,"../../shared/modules/fetch-with-timeout":5904,"../../shared/modules/mv3.utils":5909,"../../shared/modules/object.utils":5911,"../../shared/modules/selectors/networks":5918,"./constants/marketing-site-whitelist":6,"./constants/sentry-state":7,"./constants/snaps":8,"./constants/stream":9,"./first-time-state":224,"./lib/CronjobControllerStorageManager":229,"./lib/createHyperliquidReferralMiddleware":238,"./lib/deep-links/deep-link-router":249,"./lib/deep-links/metrics":250,"./lib/ens-ipfs/setup":255,"./lib/getObjStructure":257,"./lib/migrator":261,"./lib/notification-manager":265,"./lib/safe-reload":293,"./lib/setup-initial-state-hooks":296,"./lib/start-up-errors/start-up-errors":306,"./lib/state-corruption/state-corruption-recovery":307,"./lib/stores/extension-store":309,"./lib/stores/persistence-manager":311,"./lib/stores/read-only-network-store":312,"./lib/stream-utils":313,"./lib/util":332,"./metamask-controller":333,"./migrations":545,"./offscreen":546,"./platforms/extension":547,"@metamask/notification-services-controller":2284,"@metamask/utils":2908,"extension-port-stream":4366,loglevel:4824,"readable-stream":5278,"webextension-polyfill":5764},function(){with(this.scopeTerminator)with(this.globalThis)return function(){"use strict";return function(e,t,r){Object.defineProperty(r,"__esModule",{value:!0}),r.loadStateFromPersistence=Pe,r.setupController=Fe,e("./lib/setup-initial-state-hooks"),e("../../shared/constants/infura-project-id");var n=e("readable-stream"),a=Q(e("loglevel")),o=Q(e("webextension-polyfill")),s=e("@metamask/utils"),i=e("@metamask/notification-services-controller"),l=e("extension-port-stream"),c=e("../../shared/lib/promise-with-resolvers"),u=e("../../shared/constants/onboarding"),d=e("../../shared/constants/app"),p=e("../../shared/constants/messages"),f=e("../../shared/constants/background-liveness-check"),m=e("../../shared/constants/metametrics"),E=e("../../shared/modules/browser-runtime.utils"),g=e("../../shared/modules/mv3.utils"),h=e("../../shared/modules/object.utils"),b=(e("../../shared/constants/offscreen-communication"),e("../../shared/modules/selectors/networks")),C=e("../../shared/modules/caip-stream"),S=Q(e("../../shared/modules/fetch-with-timeout")),T=e("../../shared/constants/errors"),M=Q(e("../../shared/lib/get-first-preferred-lang-code")),v=(e("../../shared/lib/manifestFlags"),e("../../shared/constants/start-up-errors")),w=e("../../shared/constants/referrals"),N=e("./lib/state-corruption/state-corruption-recovery"),_=e("./lib/stores/persistence-manager"),R=Q(e("./lib/stores/extension-store")),O=(Q(e("./lib/stores/read-only-network-store")),Q(e("./migrations"))),y=Q(e("./lib/migrator")),I=Q(e("./platforms/extension")),A=e("./constants/sentry-state"),P=J(e("./lib/notification-manager")),k=J(e("./metamask-controller")),L=Q(e("./lib/getObjStructure")),U=Q(e("./lib/ens-ipfs/setup")),F=e("./lib/util"),V=e("./offscreen"),D=e("./lib/stream-utils"),j=Q(e("./first-time-state")),x=e("./constants/marketing-site-whitelist"),G=e("./constants/stream"),Y=e("./constants/snaps"),B=e("./lib/deep-links/deep-link-router"),K=e("./lib/deep-links/metrics"),H=e("./lib/safe-reload"),q=e("./lib/start-up-errors/start-up-errors"),z=e("./lib/CronjobControllerStorageManager"),$=e("./lib/createHyperliquidReferralMiddleware");function W(e){if("function"!=typeof WeakMap)return null;var t=new WeakMap,r=new WeakMap;return(W=function(e){return e?r:t})(e)}function J(e,t){if(!t&&e&&e.__esModule)return e;if(null===e||"object"!=typeof e&&"function"!=typeof e)return{default:e};var r=W(t);if(r&&r.has(e))return r.get(e);var n={__proto__:null},a=Object.defineProperty&&Object.getOwnPropertyDescriptor;for(var o in e)if("default"!==o&&{}.hasOwnProperty.call(e,o)){var s=a?Object.getOwnPropertyDescriptor(e,o):null;s&&(s.get||s.set)?Object.defineProperty(n,o,s):n[o]=e[o]}return n.default=e,r&&r.set(e,n),n}function Q(e){return e&&e.__esModule?e:{default:e}}const X="#0376C9",Z="#D73847",ee=9,te=new R.default,re=new _.PersistenceManager({localStore:te});global.stateHooks.getMostRecentPersistedState=()=>re.mostRecentRetrievedState,global.logEncryptedVault=()=>{re.logEncryptedVault()};const{sentry:ne}=global;let ae={...j.default};const oe={[d.ENVIRONMENT_TYPE_POPUP]:!0,[d.ENVIRONMENT_TYPE_NOTIFICATION]:!0,[d.ENVIRONMENT_TYPE_FULLSCREEN]:!0},se=["trezor-connect"];a.default.setLevel("info",!1);const ie=new I.default,le=new P.default,ce=(0,F.getPlatform)()===d.PLATFORM_FIREFOX;let ue=0,de=!1,pe=!1;const fe={},me={};let Ee;const ge={},he={};const be=new URL("https://metamask.github.io/phishing-warning/v5.1.0/"),Ce=be.toString();let Se,Te,Me;function ve(){const e=(0,c.withResolvers)();Se=e.promise,Te=e.resolve,Me=e.reject}globalThis.stateHooks.onInstalledListener?globalThis.stateHooks.onInstalledListener.then(je):o.default.runtime.onInstalled.addListener(function e(t){o.default.runtime.onInstalled.removeListener(e),je(t)}),ve();let we,Ne,_e,Re;const Oe=new N.CorruptionHandler;function ye(){const e=(new Date).toISOString();o.default.storage.session.set({timestamp:e})}async function Ie(e){const t=g.isManifestV3?(0,V.createOffscreen)():null,r=await Pe(e),n=r.data,s=await(0,M.default)();let i;if(g.isManifestV3){var l;if(!1!==(null===(l=n.PreferencesController)||void 0===l?void 0:l.enableMV3TimestampSave)){const e=2e3;ye(),setInterval(ye,e)}const e=await o.default.storage.session.get(["isFirstMetaMaskControllerSetup"]);i=(null==e?void 0:e.isFirstMetaMaskControllerSetup)===undefined,await o.default.storage.session.set({isFirstMetaMaskControllerSetup:i})}const c={},u=await async function(){const e=(0,S.default)(),t=Y.PREINSTALLED_SNAPS_URLS.map(async t=>{const r=await e(t);if(t.pathname.endsWith(".json.gz")){const e=new DecompressionStream("gzip"),t=r.body.pipeThrough(e);return await new Response(t).json()}return await r.json()});return Promise.all(t)}(),d=new z.CronjobControllerStorageManager;await d.init();const{update:f,requestSafeReload:h}=(0,H.getRequestSafeReload)(re);Fe(n,s,c,i,r.meta,t,u,h,d),Ee.store.on("update",f),Ee.store.on("error",e=>{a.default.error("MetaMask controller.store error:",e),null==ne||ne.captureException(e)}),function(e){async function t(e,t){try{return await o.default.tabs.update(e,{url:t})}catch(e){return null==ne?void 0:ne.captureException(e)}}const r=!g.isManifestV3;o.default.webRequest.onBeforeRequest.addListener(n=>{var a,s,i;if(n.tabId===o.default.tabs.TAB_ID_NONE)return{};const{completedOnboarding:l}=e.onboardingController.state;if(!l)return{};if(!e.preferencesController.state.usePhishDetect)return{};if(n.initiator&&"null"!==n.initiator&&new URL(n.initiator).host===be.host)return{};const{hostname:c,href:u,searchParams:d}=new URL(n.url);e.phishingController.maybeUpdateState();const p=e.phishingController.isBlockedRequest(n.url);let f,E;if("main_frame"!==n.type&&"sub_frame"!==n.type||(f=e.phishingController.test(n.url)),!(null!==(a=f)&&void 0!==a&&a.result||p.result))return{};let g=c;null!==(s=f)&&void 0!==s&&s.result&&p.result?E=`${f.type} and ${p.type}`:null!==(i=f)&&void 0!==i&&i.result?E=f.type:(E=p.type,g=n.initiator),ce||e.metaMetricsController.trackEvent({event:m.MetaMetricsEventName.PhishingPageDisplayed,category:m.MetaMetricsEventCategory.Phishing,properties:{url:g,referrer:{url:g},reason:E,requestDomain:p.result?c:undefined}},{excludeMetaMetricsId:!0});const h=new URLSearchParams({hostname:c,href:u}),b=new URL(Ce);b.hash=h.toString();const C=b.toString();return r?"main_frame"===n.type?{redirectUrl:C}:(t(n.tabId,C),{cancel:!0}):(t(n.tabId,C),{})},{urls:["http://*/*","https://*/*","ws://*/*","wss://*/*"]},r?["blocking"]:[])}(Ee),g.isManifestV3||await async function(){let e;try{const t=new URL(Ce);let r,n;t.hash="#extensionStartup",e=window.document.createElement("iframe"),e.setAttribute("src",t.href),e.setAttribute("sandbox","allow-scripts allow-same-origin");const a=new Promise((e,t)=>{r=e,n=t});e.addEventListener("load",r),window.document.body.appendChild(e),setTimeout(()=>n(new Ae),1e3),await a}catch(e){e instanceof Ae?console.warn("Phishing warning page timeout; page not guaranteed to work offline."):console.error("Failed to initialize phishing warning page",e)}finally{e&&e.remove()}}(),await(async()=>{const e=await o.default.tabs.query({url:"<all_urls>",windowType:"normal"}).then(e=>((0,E.checkForLastErrorAndLog)(),e)).catch(()=>{(0,E.checkForLastErrorAndLog)()});for(const t of e)o.default.tabs.sendMessage(t.id,{name:p.EXTENSION_MESSAGES.READY}).then(()=>{(0,E.checkForLastErrorAndLog)()}).catch(()=>{(0,E.checkForLastErrorAndLog)()})})(),new B.DeepLinkRouter({getExtensionURL:ie.getExtensionURL,getState:Ee.getState.bind(Ee)}).on("navigate",async({url:e,parsed:t})=>{"redirectTo"in t||await Ee.metaMetricsController.trackEvent((0,K.createEvent)({signature:t.signature,url:e}))}).on("error",e=>null==ne?void 0:ne.captureException(e)).install()}o.default.runtime.onConnect.addListener(async e=>{e.postMessage({data:{method:f.BACKGROUND_LIVENESS_METHOD},name:"background-liveness"});try{await Se,we(e)}catch(r){if(null==ne||ne.captureException(r),(0,T.isStateCorruptionError)(r))await Oe.handleStateCorruptionError({port:e,error:r,database:re,repairCallback:async e=>{ve(),(0,N.hasVault)(e)?(await xe(e),Ee.onboardingController.setFirstTimeFlowType(u.FirstTimeFlowType.restore)):(await re.reset(),await xe(null))}});else{var t;const n=(0,s.isObject)(r)?{message:r.message??"Unknown error",name:r.name??"UnknownError",stack:r.stack}:{message:String(r),name:"UnknownError",stack:""};(0,q.tryPostMessage)(e,v.DISPLAY_GENERAL_STARTUP_ERROR,{error:n,currentLocale:null===(t=Ee)||void 0===t||null===(t=t.preferencesController)||void 0===t||null===(t=t.state)||void 0===t?void 0:t.currentLocale})}}}),o.default.runtime.onConnectExternal.addListener(async(...e)=>{await Se,Ne(...e)});class Ae extends Error{constructor(){super("Timeout failed")}}async function Pe(e){var t,r;let n;if(e){n={data:{},meta:{}};for(const t of _.backedUpStateKeys)(0,s.hasProperty)(e,t)&&(n.data[t]=e[t]);(0,s.hasProperty)(e,"meta")&&(0,s.isObject)(e.meta)&&(n.meta=e.meta),"number"!=typeof n.meta.version&&(a.default.error("The `backup`'s `meta.version` property was missing during backup restore."),n.meta.version=155)}else{const e=!0;n=await re.get({validateVault:e})}const o=new y.default({migrations:O.default,defaultVersion:null});o.on("error",e=>{console.warn(e);const t=(0,L.default)(n);ne.captureException(e,{extra:{vaultStructure:t}})}),null!==(t=n)&&void 0!==t&&t.data||null!==(r=n)&&void 0!==r&&r.meta||(n=o.generateInitialState(ae));const i=await o.migrateData(n);if(!i)throw new Error("MetaMask - migrator returned undefined");if(!(0,s.isObject)(i.meta))throw new Error(`MetaMask - migrator metadata has invalid type '${typeof i.meta}'`);if("number"!=typeof i.meta.version)throw new Error(`MetaMask - migrator metadata version has invalid type '${typeof i.meta.version}'`);if(!(0,s.isObject)(i.data))throw new Error(`MetaMask - migrator data has invalid type '${typeof i.data}'`);return re.setMetadata(i.meta),await re.set(i.data),i}function ke(e){const{metaMetricsId:t}=Ee.metaMetricsController.state;if(!(0,F.shouldEmitDappViewedEvent)(t))return;const r=Ee.getPermittedAccounts(e).length;if(0===r)return;const n=Ee.controllerMessenger.call("PreferencesController:getState"),a=Object.keys(n.identities).length;Ee.metaMetricsController.trackEvent({event:m.MetaMetricsEventName.DappViewed,category:m.MetaMetricsEventCategory.InpageProvider,referrer:{url:e},properties:{is_first_visit:!1,number_of_accounts:a,number_of_accounts_connected:r}},{excludeMetaMetricsId:!0})}function Le(e){var t,r,n;if(null===(t=e.sender)||void 0===t||!t.tab||null===(r=e.sender)||void 0===r||!r.url||null===(n=e.sender)||void 0===n||null===(n=n.tab)||void 0===n||!n.url)return;const a=e.sender.tab.id,o=new URL(e.sender.url),{origin:s}=o,i=new URL(e.sender.tab.url),{origin:l}=i;Object.keys(ge).includes(a)||(ge[a]=s),a in he||(he[a]=l);const c=Ee.controllerMessenger.call("PermissionController:hasPermissions",s),u="New Tab"!==e.sender.tab.title;c&&u&&ke(s)}function Ue(e){const t=[d.ENVIRONMENT_TYPE_POPUP,d.ENVIRONMENT_TYPE_NOTIFICATION,d.ENVIRONMENT_TYPE_FULLSCREEN];!(Object.values(fe).some(Boolean)||de||ue>0)&&t.includes(e)&&function(){const{metaMetricsId:e,participateInMetaMetrics:t}=Ee.metaMetricsController.state;(null!==e||t)&&Ee.metaMetricsController.trackEvent({event:m.MetaMetricsEventName.AppOpened,category:m.MetaMetricsEventCategory.App})}()}function Fe(e,t,r,s,c,u,p,f,E){var S;Ee=new k.default({infuraProjectId:globalThis.INFURA_PROJECT_ID,showUserConfirmation:Ve,initState:e,initLangCode:t,platform:ie,notificationManager:le,browser:o.default,getRequestAccountTabIds:()=>me,getOpenMetamaskTabsIds:()=>fe,overrides:r,isFirstMetaMaskControllerSetup:s,currentMigrationVersion:c.version,featureFlags:{},offscreenPromise:u,preinstalledSnaps:p,requestSafeReload:f,cronjobControllerStorageManager:E}),(0,U.default)({getCurrentChainId:()=>(0,b.getCurrentChainId)({metamask:Ee.networkController.state}),getIpfsGateway:Ee.preferencesController.getIpfsGateway.bind(Ee.preferencesController),getUseAddressBarEnsResolution:()=>Ee.preferencesController.state.useAddressBarEnsResolution,provider:Ee.provider}),S=Ee,global.stateHooks.getSentryAppState=function(){const e=S.memStore.getState();return(0,h.maskObject)(e,A.SENTRY_BACKGROUND_STATE)};const T=()=>ue>0||Boolean(Object.keys(fe).length)||de,M=(e,t)=>{if(!1===e)Ee.onClientClosed();else{if(t===d.ENVIRONMENT_TYPE_FULLSCREEN&&Boolean(Object.keys(fe).length))return;Ee.onEnvironmentTypeClosed(t)}};function v(e,t){return e>t?`${t}+`:String(e)}function w(){const e=N(),t=function(){try{const{isNotificationServicesEnabled:e,isFeatureAnnouncementsEnabled:t}=Ee.notificationServicesController.state,r=Object.values(Ee.notificationServicesController.state.metamaskNotificationsList).filter(e=>e.type===i.NotificationServicesController.Constants.TRIGGER_TYPES.SNAP&&null===e.readDate).length,n=t?Ee.notificationServicesController.state.metamaskNotificationsList.filter(e=>!e.isRead&&e.type===i.NotificationServicesController.Constants.TRIGGER_TYPES.FEATURES_ANNOUNCEMENT).length:0,a=e?Ee.notificationServicesController.state.metamaskNotificationsList.filter(e=>!e.isRead&&e.type!==i.NotificationServicesController.Constants.TRIGGER_TYPES.FEATURES_ANNOUNCEMENT&&e.type!==i.NotificationServicesController.Constants.TRIGGER_TYPES.SNAP).length:0;return r+n+a}catch(e){return console.error("Failed to get unread notifications count:",e),0}}();let r="",n=X;e?r=v(e,ee):t>0&&(r=v(t,ee),n=Z);try{const e={text:r},t={color:n};g.isManifestV3?(o.default.action.setBadgeText(e),o.default.action.setBadgeBackgroundColor(t)):(o.default.browserAction.setBadgeText(e),o.default.browserAction.setBadgeBackgroundColor(t))}catch(e){console.error("Error updating browser badge:",e)}}function N(){try{return Ee.appStateController.waitingForUnlock.length+Ee.approvalController.getTotalApprovalCount()}catch(e){return console.error("Failed to get pending approval count:",e),0}}we=e=>{var t;const s=e.name;if(se.includes(e.name))return;let i=!1;const c=null!==(t=e.sender)&&void 0!==t&&t.url?new URL(e.sender.url):null;if(i=ce?oe[s]:(null==c?void 0:c.origin)===`chrome-extension://${o.default.runtime.id}`,i){var u;const t=(null==r||null===(u=r.getPortStream)||void 0===u?void 0:u.call(r,e))||new l.ExtensionPortStream(e),o=function({chunkSize:e}){Ee.metaMetricsController.trackEvent({event:m.MetaMetricsEventName.PortStreamChunked,category:m.MetaMetricsEventCategory.PortStream,properties:{chunkSize:e}})};if(e.onDisconnect.addListener(()=>t.off("message-too-large",o)),t.on("message-too-large",o),Ee.isClientOpen=!0,Ee.setupTrustedCommunication(t,e.sender),Ue(s),async function(){try{await Ee.remoteFeatureFlagController.updateRemoteFeatureFlags()}catch(e){a.default.error("Error initializing remote feature flags:",e)}}(),s===d.ENVIRONMENT_TYPE_POPUP&&(ue+=1,(0,n.finished)(t,()=>{ue-=1;const e=T();Ee.isClientOpen=e,M(e,d.ENVIRONMENT_TYPE_POPUP)})),s===d.ENVIRONMENT_TYPE_NOTIFICATION&&(de=!0,(0,n.finished)(t,()=>{de=!1;const e=T();Ee.isClientOpen=e,M(e,d.ENVIRONMENT_TYPE_NOTIFICATION)})),s===d.ENVIRONMENT_TYPE_FULLSCREEN){const r=e.sender.tab.id;fe[r]=!0,(0,n.finished)(t,()=>{delete fe[r];const e=T();Ee.isClientOpen=e,M(e,d.ENVIRONMENT_TYPE_FULLSCREEN)})}}else if(c&&c.origin===be.origin&&c.pathname===be.pathname){var p;const t=(null==r||null===(p=r.getPortStream)||void 0===p?void 0:p.call(r,e))||new l.ExtensionPortStream(e,{chunkSize:0});Ee.setupPhishingCommunication({connectionStream:t})}else{var f;if(e.sender&&e.sender.tab&&e.sender.url){const t=e.sender.tab.id,r=new URL(e.sender.url),{origin:n}=r;Le(e),e.onMessage.addListener(e=>{e.data&&e.data.method===d.MESSAGE_TYPE.ETH_REQUEST_ACCOUNTS&&(me[n]=t)})}if(c&&x.COOKIE_ID_MARKETING_WHITELIST_ORIGINS.some(e=>e===c.origin)){var E;const t=(null==r||null===(E=r.getPortStream)||void 0===E?void 0:E.call(r,e))||new l.ExtensionPortStream(e,{chunkSize:0});Ee.setUpCookieHandlerCommunication({connectionStream:t})}const t=(null==r||null===(f=r.getPortStream)||void 0===f?void 0:f.call(r,e))||new l.ExtensionPortStream(e,{chunkSize:0});if(_e(t,e.sender),ce||!g.isManifestV3){const r=(0,D.setupMultiplex)(t);r.ignoreStream(G.METAMASK_EIP_1193_PROVIDER),Re(r.createStream(G.METAMASK_CAIP_MULTICHAIN_PROVIDER),e.sender)}}},Ne=e=>{var t;const n=(null==r||null===(t=r.getPortStream)||void 0===t?void 0:t.call(r,e))||new l.ExtensionPortStream(e,{chunkSize:0});if(!e.sender.id){if(se.includes(e.name))return;Le(e),Re((0,C.createCaipStream)(n),e.sender)}else _e(n,e.sender)},_e=(e,t)=>{Ee.setupUntrustedCommunicationEip1193({connectionStream:e,sender:t})},Re=(e,t)=>{Ee.setupUntrustedCommunicationCaip({connectionStream:e,sender:t})},null!=r&&r.registerConnectListeners&&r.registerConnectListeners(we,_e),w(),Ee.controllerMessenger.subscribe(k.METAMASK_CONTROLLER_EVENTS.DECRYPT_MESSAGE_MANAGER_UPDATE_BADGE,w),Ee.controllerMessenger.subscribe(k.METAMASK_CONTROLLER_EVENTS.ENCRYPTION_PUBLIC_KEY_MANAGER_UPDATE_BADGE,w),Ee.signatureController.hub.on(k.METAMASK_CONTROLLER_EVENTS.UPDATE_BADGE,w),Ee.controllerMessenger.subscribe(k.METAMASK_CONTROLLER_EVENTS.APP_STATE_UNLOCK_CHANGE,w),Ee.controllerMessenger.subscribe(k.METAMASK_CONTROLLER_EVENTS.APPROVAL_STATE_CHANGE,w),Ee.controllerMessenger.subscribe(k.METAMASK_CONTROLLER_EVENTS.METAMASK_NOTIFICATIONS_LIST_UPDATED,w),Ee.controllerMessenger.subscribe(k.METAMASK_CONTROLLER_EVENTS.METAMASK_NOTIFICATIONS_MARK_AS_READ,w),le.on(P.NOTIFICATION_MANAGER_EVENTS.POPUP_CLOSED,({automaticallyClosed:e})=>{e?N()>0&&Ve():(Ee.signatureController.rejectUnapproved(m.REJECT_NOTIFICATION_CLOSE_SIG),Ee.decryptMessageController.rejectUnapproved(m.REJECT_NOTIFICATION_CLOSE),Ee.encryptionPublicKeyController.rejectUnapproved(m.REJECT_NOTIFICATION_CLOSE),Ee.rejectAllPendingApprovals()),w()}),Object.values(Ee.snapController.state.snaps).some(e=>!e.preinstalled)&&Ee.snapController.updateRegistry()}async function Ve(){const e=await ie.getActiveTabs(),t=Boolean(e.find(e=>fe[e.id])),r=e.length>0&&e[0].extData&&e[0].extData.indexOf("vivaldi_tab")>-1;if(!pe&&(r||0===ue)&&!t){pe=!0;try{const e=Ee.appStateController.getCurrentPopupId();await le.showPopup(e=>Ee.appStateController.setCurrentPopupId(e),e)}finally{pe=!1}}}const De=()=>{if(Ee)return Ee.metaMetricsController.updateTraits({[m.MetaMetricsUserTrait.InstallDateExt]:(new Date).toISOString().split("T")[0]}),void Ee.metaMetricsController.addEventBeforeMetricsOptIn({category:m.MetaMetricsEventCategory.App,event:m.MetaMetricsEventName.AppInstalled,properties:{}});setTimeout(()=>{De()},500)};function je(e){"install"===e.reason?(a.default.debug("First install detected"),De(),ie.openExtensionInBrowser()):"update"===e.reason&&e.previousVersion&&e.previousVersion!==ie.getVersion()&&async function(){await Se,a.default.debug("Update installation detected"),Ee.appStateController.setLastUpdatedAt(Date.now())}()}async function xe(e){o.default.tabs.onActivated.addListener(e=>{if(Ee){const{tabId:t}=e,r=ge[t],n=he[t];r&&Ee.permissionController.state.subjects[r]!==undefined&&ke(r),n===w.HYPERLIQUID_ORIGIN&&Ee.permissionController.state.subjects[n]!==undefined&&Ee.handleHyperliquidReferral(t,$.HyperliquidPermissionTriggerType.OnNavigateConnectedTab).catch(e=>{a.default.error("Failed to handle Hyperliquid referral after navigation to connected tab: ",e)})}});try{await Ie(e),re.cleanUpMostRecentRetrievedState(),a.default.info("MetaMask initialization complete."),Te()}catch(e){a.default.error(e),Me(e)}}o.default.runtime.onUpdateAvailable.addListener(async function(){await Se,a.default.debug("An update is available"),Ee.appStateController.setIsUpdateAvailable(!0)}),xe(null)}}},{package:"$root$",file:"app/scripts/background.js"}]],[4],{});